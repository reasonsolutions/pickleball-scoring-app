rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Tournament rules
    match /tournaments/{tournamentId} {
      // Allow public read access for tournaments (for home page and TV display)
      allow read: if true;
      
      // Allow creating tournaments if user is authenticated and is the creator
      allow create: if request.auth != null &&
                   request.auth.uid == request.resource.data.createdBy &&
                   isValidTournamentData(request.resource.data);
      
      // Allow updating only by the tournament creator with valid data
      allow update: if request.auth != null &&
                   request.auth.uid == resource.data.createdBy &&
                   isValidTournamentData(request.resource.data);
      
      // Allow deleting only by the tournament creator (no data validation needed for delete)
      allow delete: if request.auth != null &&
                   request.auth.uid == resource.data.createdBy;
    }
    
    // Players collection rules - TEMPORARILY RELAXED FOR DEBUGGING
    match /players/{playerId} {
      // Allow public read access for players (needed for umpire scoring and TV displays)
      allow read: if true;
      
      // TEMPORARILY ALLOW ALL AUTHENTICATED USERS TO CREATE PLAYERS - NO VALIDATION
      allow create: if request.auth != null;
      
      // Allow updating by the player creator OR by super admin OR by tournament creator
      allow update: if request.auth != null &&
                   (request.auth.uid == resource.data.createdBy ||
                    isSuperAdminSimple() ||
                    isTournamentCreator(resource.data.tournamentId)) &&
                   isValidPlayerUpdateData(request.resource.data);
      
      // Allow deleting only by the player creator (no data validation needed for delete)
      allow delete: if request.auth != null &&
                   request.auth.uid == resource.data.createdBy;
    }
    
    // Teams collection rules
    match /teams/{teamId} {
      // Allow public read access for teams (for umpire scoring, streaming overlay and TV display)
      allow read: if true;
      
      // Allow creating teams if user is authenticated and is the creator
      allow create: if request.auth != null &&
                   request.auth.uid == request.resource.data.createdBy &&
                   isValidTeamData(request.resource.data);
      
      // Allow updating only by the team creator with valid data
      allow update: if request.auth != null &&
                   request.auth.uid == resource.data.createdBy &&
                   isValidTeamData(request.resource.data);
      
      // Allow deleting only by the team creator (no data validation needed for delete)
      allow delete: if request.auth != null &&
                   request.auth.uid == resource.data.createdBy;
    }
    
    // Fixtures collection rules - COMPLETELY OPEN FOR TESTING
    match /fixtures/{fixtureId} {
      // Allow all operations for testing
      // fixtureType field is allowed as part of the open policy
      allow read, write: if true;
    }
    
    // Fixture Groups collection rules - COMPLETELY OPEN FOR TESTING
    match /fixtureGroups/{fixtureGroupId} {
      // Allow all operations for testing
      allow read, write: if true;
    }
    
    // Matches collection rules - COMPLETELY OPEN FOR TESTING
    match /matches/{matchId} {
      // Allow all operations for testing
      // playingTime field is allowed as part of the open policy
      allow read, write: if true;
    }
    
    // Users collection rules - Enhanced for super admin management
    match /users/{userId} {
      // Users can read/write their own profile
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Super admins can read all user documents
      allow read, list: if request.auth != null && isSuperAdminSimple();
      
      // Super admins can create new user documents with valid data
      allow create: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidUserData(request.resource.data);
      
      // Super admins can update user documents with valid data
      allow update: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidUserData(request.resource.data);
      
      // Super admins can delete user documents (except their own)
      allow delete: if request.auth != null &&
                   isSuperAdminSimple() &&
                   request.auth.uid != userId;
    }
    
    // Venues collection rules
    match /venues/{venueId} {
      // Allow public read access for venues (needed for fixture display)
      allow read: if true;
      
      // Only super admins can create, update, or delete venues
      allow create: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidVenueData(request.resource.data);
      
      allow update: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidVenueData(request.resource.data);
      
      allow delete: if request.auth != null &&
                   isSuperAdminSimple();
    }
    
    // Featured Videos collection rules
    match /featuredVideos/{videoId} {
      // Allow public read access for featured videos (needed for home page)
      allow read: if true;
      
      // Only super admins can create, update, or delete featured videos
      allow create: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidFeaturedVideoData(request.resource.data);
      
      allow update: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidFeaturedVideoData(request.resource.data);
      
      allow delete: if request.auth != null &&
                   isSuperAdminSimple();
    }
    
    // News collection rules
    match /news/{newsId} {
      // Allow public read access for news (needed for home page)
      allow read: if true;
      
      // Only super admins can create, update, or delete news
      allow create: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidNewsData(request.resource.data);
      
      allow update: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidNewsData(request.resource.data);
      
      allow delete: if request.auth != null &&
                   isSuperAdminSimple();
    }
    
    // Display Settings collection rules
    match /display_settings/{settingId} {
      // Allow public read access for display settings (needed for main display)
      allow read: if true;
      
      // Only super admins can create, update, or delete display settings
      allow create: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidDisplaySettingData(request.resource.data);
      
      allow update: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidDisplaySettingData(request.resource.data);
      
      allow delete: if request.auth != null &&
                   isSuperAdminSimple();
    }
    
    // Overlay Controls collection rules - for streaming overlay player cards
    match /overlay_controls/{controlId} {
      // Allow public read and write access for overlay controls (needed for streaming functionality)
      allow read, write: if true;
    }
    
    // Video Links collection rules - for ads videos management
    match /video_links/{tournamentId} {
      // Allow public read access for video links (needed for display)
      allow read: if true;
      
      // Only super admins can create, update, or delete video links
      allow create: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidVideoLinksData(request.resource.data);
      
      allow update: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidVideoLinksData(request.resource.data);
      
      allow delete: if request.auth != null &&
                   isSuperAdminSimple();
    }
    
    // Tournament Logos collection rules - for logo management
    match /tournament_logos/{tournamentId} {
      // Allow public read access for tournament logos (needed for display)
      allow read: if true;
      
      // Only super admins can create, update, or delete tournament logos
      allow create: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidTournamentLogosData(request.resource.data);
      
      allow update: if request.auth != null &&
                   isSuperAdminSimple() &&
                   isValidTournamentLogosData(request.resource.data);
      
      allow delete: if request.auth != null &&
                   isSuperAdminSimple();
    }
    
    // Function to validate news data structure
    function isValidNewsData(data) {
      return data.keys().hasAll(['title', 'subtext', 'publishDate']) &&
             data.title is string &&
             data.subtext is string &&
             data.publishDate is timestamp &&
             (data.description == null || data.description is string) &&
             (data.featuredImage == null ||
              data.featuredImage is string ||
              (data.featuredImage is map &&
               (('url' in data.featuredImage && data.featuredImage.url is string) ||
                ('secure_url' in data.featuredImage && data.featuredImage.secure_url is string)) &&
               (!('public_id' in data.featuredImage) || data.featuredImage.public_id is string))) &&
             (data.featured == null || data.featured is bool) &&
             (data.createdAt == null || data.createdAt is timestamp) &&
             (data.updatedAt == null || data.updatedAt is timestamp);
    }
    
    // Function to validate featured video data structure
    function isValidFeaturedVideoData(data) {
      return data.keys().hasAll(['title', 'youtubeUrl', 'videoId']) &&
             data.title is string &&
             data.youtubeUrl is string &&
             data.videoId is string &&
             (data.description == null || data.description is string) &&
             (data.createdAt == null || data.createdAt is timestamp) &&
             (data.updatedAt == null || data.updatedAt is timestamp);
    }
    
    // Function to validate venue data structure
    function isValidVenueData(data) {
      return data.keys().hasAll(['name', 'createdBy']) &&
             data.name is string &&
             data.createdBy is string &&
             (data.createdAt == null || data.createdAt is timestamp);
    }
    
    // Function to validate tournament data structure
    function isValidTournamentData(data) {
      return data.keys().hasAll(['name', 'description', 'rules', 'prizeMoney', 'startDate', 'endDate', 'categories', 'createdBy']) &&
             data.name is string &&
             data.description is string &&
             data.rules is string &&
             data.prizeMoney is number &&
             data.startDate is timestamp &&
             data.endDate is timestamp &&
             data.categories is map &&
             data.categories.keys().hasAll(['mensSingles', 'mensDoubles', 'womensSingles', 'womensDoubles', 'mixedDoubles']) &&
             data.categories.mensSingles is bool &&
             data.categories.mensDoubles is bool &&
             data.categories.womensSingles is bool &&
             data.categories.womensDoubles is bool &&
             data.categories.mixedDoubles is bool &&
             data.createdBy is string;
    }
    
    // Function to validate player data structure
    function isValidPlayerData(data) {
      return data.keys().hasAll(['name', 'tournamentId', 'createdBy']) &&
             data.name is string &&
             data.tournamentId is string &&
             data.createdBy is string &&
             (data.age == null || data.age is number) &&
             (data.gender == null || data.gender is string) &&
             (data.duprId == null || data.duprId is string) &&
             (data.photo == null ||
              data.photo is string || // Allow direct URL strings for bulk upload
              (data.photo is map &&
               data.photo.keys().hasAll(['url']) &&
               data.photo.url is string &&
               (data.photo.publicId == null || data.photo.publicId is string))) &&
             // Backward compatibility photo fields
             (data.photoUrl == null || data.photoUrl is string) &&
             (data.photoPublicId == null || data.photoPublicId is string) &&
             // New rating and statistics fields
             (data.doublesRating == null || data.doublesRating is number) &&
             (data.doublesWins == null || data.doublesWins is number) &&
             (data.doublesLosses == null || data.doublesLosses is number) &&
             (data.singlesRating == null || data.singlesRating is number) &&
             (data.singlesWins == null || data.singlesWins is number) &&
             (data.singlesLosses == null || data.singlesLosses is number) &&
             // Allow createdAt and updatedAt timestamp fields
             (data.createdAt == null || data.createdAt is timestamp) &&
             (data.updatedAt == null || data.updatedAt is timestamp);
   }
   
   // Function to validate player data structure for updates (more flexible)
   function isValidPlayerUpdateData(data) {
     return data.keys().hasAll(['name', 'tournamentId', 'createdBy']) &&
            data.name is string &&
            data.tournamentId is string &&
            data.createdBy is string &&
            (data.age == null || data.age is number) &&
            (data.gender == null || data.gender is string) &&
            (data.duprId == null || data.duprId is string) &&
            (data.photo == null ||
             data.photo is string || // Allow direct URL strings for bulk upload
             (data.photo is map &&
              data.photo.keys().hasAll(['url']) &&
              data.photo.url is string &&
              (data.photo.publicId == null || data.photo.publicId is string))) &&
            // Backward compatibility photo fields
            (data.photoUrl == null || data.photoUrl is string) &&
            (data.photoPublicId == null || data.photoPublicId is string) &&
            // New rating and statistics fields
            (data.doublesRating == null || data.doublesRating is number) &&
            (data.doublesWins == null || data.doublesWins is number) &&
            (data.doublesLosses == null || data.doublesLosses is number) &&
            (data.singlesRating == null || data.singlesRating is number) &&
            (data.singlesWins == null || data.singlesWins is number) &&
            (data.singlesLosses == null || data.singlesLosses is number) &&
            // Allow updatedAt timestamp for updates
            (data.updatedAt == null || data.updatedAt is timestamp);
   }
    
    // Function to validate team data structure
    function isValidTeamData(data) {
      return data.keys().hasAll(['name', 'playerIds', 'tournamentId', 'createdBy']) &&
             data.name is string &&
             data.playerIds is list &&
             data.tournamentId is string &&
             data.createdBy is string &&
             (data.description == null || data.description is string) &&
             (data.adminEmail == null || data.adminEmail is string) &&
             (data.adminUid == null || data.adminUid is string) &&
             (data.logo == null || (data.logo is map &&
              data.logo.keys().hasAll(['url']) &&
              data.logo.url is string &&
              (data.logo.publicId == null || data.logo.publicId is string)));
    }
    
    // Enhanced function to check if current user is super admin
    function isSuperAdminSimple() {
      // Check hardcoded super admin email for backward compatibility OR database role
      return request.auth != null &&
             (request.auth.token.email == 'siddharth@318digital.com' ||
              isSuperAdminFromDatabase());
    }
    
    // Function to check if user has super_admin role in database
    function isSuperAdminFromDatabase() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Function to validate user data structure for super admin creation
    function isValidUserData(data) {
      return data.keys().hasAll(['uid', 'email', 'role']) &&
             data.uid is string &&
             data.email is string &&
             data.role is string &&
             data.role in ['super_admin', 'team_admin'] &&
             (data.displayName == null || data.displayName is string) &&
             (data.photoURL == null || data.photoURL is string) &&
             (data.teamName == null || data.teamName is string) &&
             (data.tournamentId == null || data.tournamentId is string) &&
             (data.tempPassword == null || data.tempPassword is string) &&
             (data.createdAt == null || data.createdAt is timestamp) &&
             (data.updatedAt == null || data.updatedAt is timestamp) &&
             (data.createdBy == null || data.createdBy is string);
    }
    
    // Function to validate display setting data structure
    function isValidDisplaySettingData(data) {
      return data.keys().hasAll(['tournamentId', 'date', 'currentFixture']) &&
             data.tournamentId is string &&
             data.date is string &&
             data.currentFixture is map &&
             data.currentFixture.keys().hasAll(['fixtureGroupId', 'team1Name', 'team2Name']) &&
             data.currentFixture.fixtureGroupId is string &&
             data.currentFixture.team1Name is string &&
             data.currentFixture.team2Name is string &&
             (data.updatedAt == null || data.updatedAt is timestamp);
    }
    
    // Function to validate video links data structure (now supports mixed media)
    function isValidVideoLinksData(data) {
      return data.keys().hasAll(['tournamentId']) &&
             data.tournamentId is string &&
             // Support both old format (links) and new format (mediaItems)
             (('links' in data && data.links is list && isValidVideoLinksArray(data.links)) ||
              ('mediaItems' in data && data.mediaItems is list && isValidMediaItemsArray(data.mediaItems)) ||
              ('links' in data && 'mediaItems' in data &&
               data.links is list && data.mediaItems is list &&
               isValidVideoLinksArray(data.links) && isValidMediaItemsArray(data.mediaItems))) &&
             (data.updatedAt == null || data.updatedAt is timestamp);
    }
    
    // Function to validate individual video link objects in the array (backward compatibility)
    function isValidVideoLinksArray(links) {
      return links.size() >= 0 &&
             links.size() <= 50; // Reasonable limit - simplified validation
    }
    
    // Function to validate individual media item objects in the array (new format)
    function isValidMediaItemsArray(mediaItems) {
      return mediaItems.size() >= 0 &&
             mediaItems.size() <= 50 && // Reasonable limit
             // Simplified validation - each item should have basic required fields
             (mediaItems.size() == 0 ||
              (mediaItems[0].keys().hasAny(['id', 'type', 'url', 'title', 'rank']) &&
               (mediaItems[0].type == null || mediaItems[0].type in ['video', 'image']) &&
               (mediaItems[0].url == null || mediaItems[0].url is string) &&
               (mediaItems[0].title == null || mediaItems[0].title is string) &&
               (mediaItems[0].rank == null || mediaItems[0].rank is number)));
  }
  
  // Function to validate tournament logos data structure
  function isValidTournamentLogosData(data) {
    return data.keys().hasAll(['tournamentId', 'displayLogos']) &&
           data.tournamentId is string &&
           data.displayLogos is list &&
           data.displayLogos.size() >= 0 &&
           data.displayLogos.size() <= 20 && // Reasonable limit for logos
           (data.updatedAt == null || data.updatedAt is timestamp) &&
           // Simplified validation for logo items
           (data.displayLogos.size() == 0 ||
            (data.displayLogos[0].keys().hasAny(['id', 'url', 'title', 'rank']) &&
             (data.displayLogos[0].url == null || data.displayLogos[0].url is string) &&
             (data.displayLogos[0].title == null || data.displayLogos[0].title is string) &&
             (data.displayLogos[0].rank == null || data.displayLogos[0].rank is number) &&
             (data.displayLogos[0].publicId == null || data.displayLogos[0].publicId is string)));
  }
  
  // Function to check if current user is a team admin for a specific tournament
   function isTeamAdminForPlayer(tournamentId) {
     return request.auth != null &&
            exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'team_admin' &&
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tournamentId == tournamentId;
   }
   
   // Function to check if current user is the tournament creator
   function isTournamentCreator(tournamentId) {
     return request.auth != null &&
            exists(/databases/$(database)/documents/tournaments/$(tournamentId)) &&
            get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.createdBy == request.auth.uid;
   }
 }
}